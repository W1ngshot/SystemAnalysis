@startuml
title Получение профиля авторизированного пользователя

actor Пользователь as "UI"
participant Прокси as "Reverse Proxy"
participant Приложение as "Сервер"
participant Redis as "Redis"
participant Keycloak as "Keycloak"
database БД as "База данных"

Пользователь -> Прокси : Отправить GET /user/me с JWT токеном
Прокси -> Приложение : Прокинуть запрос с JWT токеном
Приложение -> Redis : Проверить метаданные токена в Redis

alt Метаданные найдены
    Приложение -> Приложение : Проверить токен (валидность, срок действия)
else Метаданные отсутствуют
    Приложение -> Keycloak : Запросить метаданные токена
    Keycloak --> Приложение : Ответ с метаданными токена
    Приложение -> Redis : Записать метаданные в Redis
    Приложение -> Приложение : Проверить токен (валидность, срок действия)
end

alt Токен валиден
    Приложение -> БД : Получить данные пользователя
    БД --> Приложение : Данные пользователя
    Приложение --> Прокси : Ответ 200 OK с данными пользователя
    Прокси --> Пользователь : Ответ 200 OK с данными пользователя
else Токен истек или недействителен
    Приложение --> Прокси : Ответ 401 Unauthorized
    Прокси --> Пользователь : Ответ 401 Unauthorized
end

@enduml