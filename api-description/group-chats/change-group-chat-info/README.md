# Описание эндпоинта `Изменение информации о групповом чате`

## 1. Протокол взаимодействия  

**HTTP/1.1 & REST**  

## 2. Метод запроса  

**PUT**  

## 3. URL  

`/group-chat/{conversationId}/info`  

## 4. Используемые заголовки  

- `Content-Type: application/json`  
- `Authorization: Bearer <токен>`  

## 5. Требования  

- ### 5.1. Аутентификация/Авторизация  

  - **Необходимость**: Обязательно.  
  - **Как работает**: Для выполнения запроса требуется передача валидного Bearer токена в заголовке `Authorization`.  

- ### 5.2. Кэширование  

  - **Необходимость**: Опционально.  
  - **Как работает**:  
    - На уровне обработки обращение к `Redis` для уменьшения запросов к БД и Minio. 

## 6. Структура запроса  

| **Параметр**     | **Передача** | **Обязательность** | **Тип данных** | **Описание**                  | **Условия валидации**     | **Значения по умолчанию / Допустимые значения** |
|----------------- |--------------|--------------------|----------------|-------------------------------|---------------------------|-------------------------------------------------|
| `conversationId` | `path`       | Обязательный       | `string`       | Уникальный идентификатор чата | Должен быть валидным UUID | Нет значения по умолчанию                       |
| `newTitle`       | `body`       | Обязательный       | `string`       | Новое название чата           | Длина должна быть от 1 до 100 символов | Нет значения по умолчанию          |
| `newDescription` | `body`       | Необязательный     | `string`       | Новое описание чата           | Длина должна быть от 1 до 500 символов | Нет значения по умолчанию          |
| `newPictureId`   | `body`       | Необязательный     | `string`       | Новая картинка чата           | Должен быть валидным UUID | Нет значения по умолчанию                       |

## 7. Структура ответа  

У ответа отсутвуют данные в ответе.

## 8. Алгоритм обработки запроса

- ### 8.1 Валидации
  - Валидация `conversationId` на уровне роутинга на соответствие UUID.
  - Валидация `newTitle` и `newDescriptionId` на уровне эндпоинта
  - Валидация `newPictureId` на уровне обработки на совпадение с уже установленным `picture_id` или существование записи в таблице `Files` при том, что `sender_id` у изображения совпадает с `id` текущего пользователя.

- ### 8.2 Обработки
  - Получение данных из `GroupChatMembers` по `user_id` и `conversation_id`
  - Проверка существования записи
  - Проверка полей `is_excluded` и `is_banned`
  - Проверка поля `permissions`
  - Запрос файла из `Files` по `id` и проверка автора изображения `sender_id`
  - Получение записи из `GroupChatInfos` по `conversation_id`
  - Замена необходимых полей


- ### 8.3 Наполнение из БД
  - Наполнение отсутствует, так как операция только изменяет данные и не возвращает.

- ### 8.4 Используемые таблицы
  - `GroupChatMembers`
  - `Files`
  - `GroupChatInfos`

- ### 8.5 Вызовы других систем в рамках обработки
  - **Keycloak:**
    - Запрос метаданных авторизации для проверки подлинности токена (если их нет в кэше)  

## 9. Код состояния ответа

- `204 No Content`: Успешное выполнение запроса.
- `400 Bad Request`: Введенные данные не валидны.
- `401 Unauthorized`: Отсутствует или неверный токен.
- `403 Forbidden`: Пользователь не является действующим участником чата или не имеет нужных прав.
- `404 Not Found`: Так как за валидацию `conversationId` отвечает роутинг ASP. NET, то при невалидном UUID энпоинт просто не найдется.
- `500 Internal Server Error`: Внутренняя ошибка сервера.

## 10. Ошибки

- ### 400 Bad Request
  
  - **Response Body:**
    ```json
    {
      "type": "https://tools.ietf.org/html/rfc7231#section-6.5.1",
      "title": "VALIDATION_FAILED",
      "status": 400,
      "errors": {
        "newTitle": [
          {
            "message": "MUST_NOT_BE_EMPTY",
            "localizationValues": {}
          }
        ],
        "newDescription": [
          {
            "message": "LENGTH_MUST_BE_AT_MAX",
            "localizationValues": {
              "maxLength": 500,
              "totalLength": 501
            }
          }
        ]
      }
    }
    ```

- ### 401 Unauthorized

  - **Response body:** Отсутствует.

- ### 403 Forbidden

  - **Response body:**
    ```json 
    {
      "title": "title",
      "status": 403
    }
    ```

  - **Titles:**
    - `NOT_CHAT_MEMBER`: Пользователь не состоит в чате.
    - `WAS_BANNED`: Пользователь был забанен в чате.
    - `WAS_EXCLUDED`: Пользователь был исключен из чата.
    - `NOT_ENOUGH_PERMISSIONS`: У пользователя нет прав на редактирование информации группового чата.

- ### 404 Not Found

  - **Response body:** Отсутствует.

- ### 500 Internal Server Error

  - **Response body:**
    ```json 
    {
      "title": "INTERNAL_SERVER_ERROR",
      "status": 500
    }
    ```

## 11. Примеры запроса и ответа

### Пример запроса

```http
PUT /group-chat/4d0a8fa6-364f-4141-b0d3-b21cacaf300a/info HTTP/1.1  
Host: api.messenger.com  
Content-Type: application/json  
Authorization: Bearer token
```

**Request Body:**
```json
{
  "newTitle": "New Test Title",
  "newDescription": "New Test description",
  "newPictureId": "3f85f64-5717-4562-b3fc-2c963f66af6"
}
```

### Пример ответа

```http
HTTP/1.1 204 No Content  
Date: Tue, 23 Jan 2025 12:00:00 GMT
```
