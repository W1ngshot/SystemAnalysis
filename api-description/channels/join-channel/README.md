# Описание эндпоинта `Изменение информации о групповом чате`

## 1. Протокол взаимодействия  

**HTTP/1.1 & REST**  

## 2. Метод запроса  

**PUT**  

## 3. URL  

`/channel/{conversationId}/join`  

## 4. Используемые заголовки  

- `Content-Type: application/json`  
- `Authorization: Bearer <токен>`  

## 5. Требования  

- ### 5.1. Аутентификация/Авторизация  

  - **Необходимость**: Обязательно.  
  - **Как работает**: Для выполнения запроса требуется передача валидного Bearer токена в заголовке `Authorization`.  

- ### 5.2. Кэширование  

  - **Необходимость**: Опционально.  
  - **Как работает**:  
    - На уровне обработки обращение к `Redis` для уменьшения запросов к БД. 

## 6. Структура запроса  

| **Параметр**     | **Передача** | **Обязательность** | **Тип данных** | **Описание**                  | **Условия валидации**     | **Значения по умолчанию / Допустимые значения** |
|----------------- |--------------|--------------------|----------------|-------------------------------|---------------------------|-------------------------------------------------|
| `conversationId` | `path`       | Обязательный       | `string`       | Уникальный идентификатор чата | Должен быть валидным UUID | Нет значения по умолчанию                       |

## 7. Структура ответа  

У ответа отсутвуют данные.

## 8. Алгоритм обработки запроса

- ### 8.1 Валидации
  - Валидация `conversationId` на уровне роутинга на соответствие UUID.

- ### 8.2 Обработки
  - Проверка, что `Conversation` по введенному `conversationId` является каналом.
  - Получение данных из `ConversationUserStatuses` по `user_id` и `conversation_id`.

    #### Если `ConversationUserStatus` уже существует
      - `is_deleted_by_user` устанавливается `false`
  
    #### Если `ConversationUserStatus` не существует
      - Создается запись в `ChannelMembers` с минимальными `permissions`.
      - Создается запись в `ConversationUserStatuses`.

- ### 8.3 Наполнение из БД
  - Наполнение отсутствует, так как операция только изменяет данные и не возвращает.

- ### 8.4 Используемые таблицы
  - `Conversation`
  - `ConversationUserStatus`
  - `ChannelMembers`

- ### 8.5 Вызовы других систем в рамках обработки
  - **Keycloak:**
    - Запрос метаданных авторизации для проверки подлинности токена (если их нет в кэше)  

## 9. Код состояния ответа

- `204 No Content`: Успешное выполнение запроса.
- `401 Unauthorized`: Отсутствует или неверный токен.
- `404 Not Found`: Так как за валидацию `conversationId` отвечает роутинг ASP. NET, то при невалидном UUID энпоинт просто не найдется.
- `500 Internal Server Error`: Внутренняя ошибка сервера.

## 10. Ошибки

- ### 401 Unauthorized

  - **Response body:** Отсутствует.

- ### 404 Not Found

  - **Response body:** Отсутствует.

- ### 500 Internal Server Error

  - **Response body:**
    ```json 
    {
      "title": "INTERNAL_SERVER_ERROR",
      "status": 500
    }
    ```

## 11. Примеры запроса и ответа

### Пример запроса

```http
PUT /channel/4d0a8fa6-364f-4141-b0d3-b21cacaf300a/join HTTP/1.1  
Host: api.messenger.com  
Content-Type: application/json  
Authorization: Bearer token
```

### Пример ответа

```http
HTTP/1.1 204 No Content  
Date: Tue, 23 Jan 2025 12:00:00 GMT
```
